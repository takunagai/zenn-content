---
title: "Mac: iCloud Drive の指定フォルダをローカルに保持し続ける方法"
emoji: "🐸"
type: "tech"
topics: [mac, 開発環境, markdown, windsurf, iawriter]
published: true
---

MacOS の iCloud Drive は便利なクラウドストレージですが、Macのストレージ容量が不足してきた時に自動でファイルをクラウドへ戻してしまう仕様があります。

普段は気にならなくても、頻繁に使うフォルダやアプリのデータがクラウドに移動してしまうと、ローカルに存在しないために不便を感じることがあります。

私のケースでは、iA Writer の書庫（フォルダ）を iCloud Drive に置きクラウドと同期させながら、常にローカルに存在するようにしたい という要件がありました。Obsidian で同様の場合もご参考いただけます。

:::message
iA Writer (この Zenn 記事も iA Writer の管理下に置いています) で管理しているファイルをコーディング用エディタ (Windsurf) で編集することがあり、このフォルダのデータがクラウド上に移動してしまうと、バージョン管理がうまくできなくなったり、オフラインで作業ができなくなるためです。
:::

その解決策として、`touch -a` コマンドを定期的に走らせ、ファイルのアクセス時間（atime）を更新する方法を採用しました。

## `touch -a` で iCloud Drive の特定フォルダをローカルに保持する

`touch -a ファイルパス` コマンドを使うと、ファイルのアクセス時間（atime）だけを変更することができます。これは、iCloud Drive に「このファイルは最近使われている」と認識させる効果があります。その結果、ファイルがクラウドへ戻されるのを防ぐことができます。

iCloud Driveのファイルをクラウドに戻す際のアクセス頻度の判定基準は、最近24時間以内にアクセスされていないファイルが優先的に対象となるとのことです。[» 参考](https://discussions.apple.com/thread/6327649?tstart=0&t=undefined&sortBy=rank)

以下のコマンドを定期的に実行することで、特定のフォルダ内のファイルをローカルに保持できます。

```sh
find ~/Library/Mobile\ Documents/com~apple~CloudDocs/iAWriter -type f -exec touch -a {} \;
```

このコマンドは、iCloud Drive 内の `iAWriter` フォルダのすべてのファイルに対して `touch -a` を適用し、アクセス時間を更新します。

このコマンドを `cron` で定期的に自動実行するようスケジュール登録します。

次に進む前に、`atime` でアクセス時間の更新がデフォルトで無効化されていないかチェックします。もし出力に `noatime` が含まれている場合は、この記事の "atime の更新が無効になっている場合の対処法" の手順を先に実行してください。

### cron でスケジュール登録する

`cron` を使うと、指定した間隔でコマンドを実行できます。以下の手順で設定します。

1. ターミナルを開き、以下のコマンドで `crontab` を編集します (viエディタが開きます)。

   ```sh
   crontab -e
   ```

2. 以下のエントリ (指定時間ごとに `touch -a` を実行、ログを出力) を追加。

   ```sh
   0 */12 * * * find ~/Library/Mobile\ Documents/com~apple~CloudDocs/iAWriter -type f -exec touch -a {} \; >> ~/cron_log.txt 2>&1
   ```

   * `0` 毎回0分に
   * `*/12` 12時間おきに（0時、12時）
   * `* * *` 毎日、毎月、すべての曜日
   * `>> ~/cron_log.txt 2>&1` ログを出力

3. 保存して `crontab` を終了します。viエディタで保存するには、`:wq` を入力し改行キーで実行 (初回は Mac のセキュリティ警告が出るので許可が必要)。

## メモ1: フォルダを右クリックし、「ダウンロードを保持」ではダメなの？

基本的には、右クリックして「ダウンロードを保持」を選択すれば、そのフォルダやファイルはローカルに保存され続けるはずです。しかし、macOS の 「最適化されたストレージ」 が有効になっている場合、ストレージの空き容量が少なくなると、強制的にファイルが iCloud に戻される可能性があります。また、アップデートで挙動が変わる可能性もあります。

## メモ2：Mac の設定で「最適化されたストレージ」を無効にすれば良いのでは？

システム設定 > Apple ID > iCloud > Macのストレージを最適化 のチェックを外すことでも、iCloud Drive のファイルが自動的にクラウドへ戻されるのを防ぐことができます。しかし、この方法ではすべての iCloud Drive ファイルがローカルに保存されてしまうため、今回は不採用としました。

## メモ3：macOS の `atime` の更新が無効になっている場合の対処法

`mount | grep iCloud` の出力に `noatime` が含まれている場合、`atime` の更新が無効化されています。もし `atime` の更新が機能しない場合は、`cat` コマンドで定期的にファイルを参照するという方法が有効です。

```sh
find ~/Library/Mobile\ Documents/com~apple~CloudDocs/iAWriter -type f -exec cat {} > /dev/null \;
```

これにより、システムが「ファイルが開かれた」と認識し、クラウドへ戻されるのを防ぐことができます。

## まとめ

iCloud Drive 上の特定のフォルダを常にローカルに保持するには、

* `touch -a` コマンドを定期的に実行して `atime` を更新する
という方法が有効です。

これにより、オフラインでも安心して作業できる環境を維持できます。iCloud Drive の自動管理はローカルMacのストレージ容量の節約に便利ですが、制御したい場面ではこうした工夫が役立ちます。ぜひ試してみてください！
